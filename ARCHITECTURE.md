# 巴菲特股息筛选系统架构文档

## 架构概览

本系统采用模块化架构，在保持简洁性的同时提高了代码的可维护性和可扩展性。

## 架构原则

### 1. 简洁优先
- **单一职责原则**：每个模块只负责一个特定功能
- **最小依赖**：只保留必要的依赖关系
- **直接明了**：避免过度抽象，保持代码易于理解

### 2. 模块化设计
- **松耦合**：模块间通过清晰的接口通信
- **高内聚**：相关功能集中在同一模块内
- **可测试**：每个模块都可以独立测试

## 模块结构

```
buffett/
├── main.py              # 主程序入口和CLI接口
├── models.py            # 数据模型定义
├── config.py            # 配置管理
├── data_provider.py     # 数据访问层
├── scoring.py           # 评分系统
├── reporter.py          # 报告生成器
├── __init__.py          # 包初始化文件
├── sample_stocks.txt    # 示例股票列表
├── pyproject.toml       # 项目配置
└── reports/             # 结果输出目录
```

## 核心模块详解

### 1. 数据模型层 (`models.py`)

#### 数据类
- **`StockInfo`**: 股票信息数据模型
- **`ScreeningCriteria`**: 筛选条件配置
- **`ScreeningResult`**: 筛选结果容器

#### 设计特点
- 使用 `@dataclass` 简化数据类定义
- 提供类型安全和数据验证
- 支持序列化和反序列化

### 2. 配置管理 (`config.py`)

#### 配置类
- **`DataConfig`**: 数据源配置
- **`ScoringConfig`**: 评分系统配置
- **`AppConfig`**: 应用全局配置

#### 设计特点
- 支持环境变量覆盖
- 提供默认配置
- 配置项分类管理

### 3. 数据访问层 (`data_provider.py`)

#### 核心类
- **`StockDataProvider`**: 股票数据提供者

#### 主要功能
- AKShare API 封装
- 数据标准化和验证
- 错误处理和重试机制
- 请求频率控制

#### 设计模式
- **适配器模式**: 适配不同数据源
- **策略模式**: 可配置的数据获取策略

### 4. 评分系统 (`scoring.py`)

#### 核心类
- **`InvestmentScorer`**: 投资评分器

#### 评分算法
- **股息率评分** (40%): 基于 TTM 股息率
- **估值评分** (30%): 基于 P/E 和 P/B 比率
- **技术位置评分** (20%): 基于 52 周位置
- **基本面评分** (10%): 基于 EPS 和账面价值

#### 设计特点
- 可配置的评分权重
- 模块化的评分算法
- 支持评分策略扩展

### 5. 报告生成器 (`reporter.py`)

#### 核心类
- **`StockReporter`**: 报告生成器

#### 主要功能
- 控制台格式化输出
- JSON 格式结果保存
- 筛选摘要生成
- 文件管理

### 6. 主程序 (`main.py`)

#### 核心类
- **`BuffettScreener`**: 主筛选器

#### 功能特点
- CLI 参数解析
- 模块编排和协调
- 错误处理和用户反馈

## 数据流架构

### 筛选流程
```
1. CLI 输入 → 参数解析 → 创建筛选器
2. 数据获取 → 数据清洗 → 股票筛选
3. 详细分析 → 评分计算 → 结果排序
4. 报告生成 → 控制台输出 → 文件保存
```

### 模块交互
```
main.py
├── data_provider.py (数据获取)
├── scoring.py (评分计算)
├── reporter.py (结果输出)
└── models.py (数据模型)

config.py (全局配置)
└── 所有模块
```

## 设计模式应用

### 1. 策略模式
- **评分策略**: `InvestmentScorer` 支持不同评分算法
- **数据策略**: `StockDataProvider` 支持不同数据源

### 2. 建造者模式
- **结果构建**: `ScreeningResult` 通过建造者模式构建
- **配置构建**: `AppConfig` 支持链式配置

### 3. 适配器模式
- **数据适配**: 适配 AKShare 数据格式
- **输出适配**: 适配不同输出格式

## 扩展性设计

### 1. 数据源扩展
- 可以轻松添加新的数据源
- 支持多数据源聚合
- 统一的数据接口

### 2. 评分算法扩展
- 模块化的评分算法
- 可配置的评分权重
- 支持自定义评分策略

### 3. 输出格式扩展
- 支持多种输出格式
- 可配置的报告模板
- 支持实时流式输出

## 性能优化

### 1. 数据获取优化
- 请求频率控制
- 数据缓存机制
- 并发请求支持

### 2. 内存优化
- 流式数据处理
- 及时释放资源
- 避免数据重复

### 3. 计算优化
- 批量计算
- 延迟计算
- 结果缓存

## 错误处理策略

### 1. 分层错误处理
- **数据层**: 数据获取错误处理
- **业务层**: 业务逻辑错误处理
- **表现层**: 用户界面错误处理

### 2. 错误恢复机制
- 自动重试
- 降级处理
- 用户友好的错误提示

## 测试策略

### 1. 单元测试
- 每个模块独立测试
- Mock 外部依赖
- 覆盖核心逻辑

### 2. 集成测试
- 模块间交互测试
- 端到端流程测试
- 数据一致性测试

## 部署架构

### 1. 单机部署
- 简单的命令行工具
- 本地文件系统存储
- 配置文件管理

### 2. 容器化部署
- Docker 容器化
- 环境变量配置
- 数据卷挂载

## 安全考虑

### 1. 数据安全
- 敏感信息脱敏
- 数据传输加密
- 访问权限控制

### 2. 系统安全
- 输入验证
- 异常处理
- 日志审计

## 总结

这个架构在保持简洁性的同时，通过模块化设计提高了代码的可维护性和可扩展性。每个模块职责明确，接口清晰，便于测试和维护。系统设计遵循 SOLID 原则，具有良好的扩展性和灵活性。